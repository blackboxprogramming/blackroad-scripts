name: Auto-Generate Workflow ID

on:
  # Trigger when item is added to project
  project_card:
    types: [created]
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  generate-workflow-id:
    runs-on: ubuntu-latest
    if: github.event.issue
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate Workflow ID
        id: generate-id
        run: |
          # Generate workflow ID
          PREFIX="WF"
          SCOPE="SYS"
          TIMESTAMP=$(date +%Y%m%d)
          
          # Get sequence from GitHub cache or start at 1
          SEQ_FILE="workflow-seq-${TIMESTAMP}"
          
          if [ -f "$SEQ_FILE" ]; then
            SEQ=$(cat "$SEQ_FILE")
            SEQ=$((SEQ + 1))
          else
            SEQ=1
          fi
          
          echo "$SEQ" > "$SEQ_FILE"
          
          # Format with zero-padding
          SEQ_PADDED=$(printf "%04d" $SEQ)
          
          # Generate ID
          WORKFLOW_ID="${PREFIX}-${TIMESTAMP}-${SCOPE}-${SEQ_PADDED}"
          
          echo "workflow_id=$WORKFLOW_ID" >> $GITHUB_OUTPUT
          echo "Generated: $WORKFLOW_ID"
      
      - name: Detect prefix from labels
        id: detect-prefix
        run: |
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          
          PREFIX="WF"
          if echo "$LABELS" | grep -qi "security"; then
            PREFIX="SEC"
          elif echo "$LABELS" | grep -qi "infrastructure"; then
            PREFIX="INF"
          elif echo "$LABELS" | grep -qi "experiment"; then
            PREFIX="EXP"
          elif echo "$LABELS" | grep -qi "hotfix\|urgent"; then
            PREFIX="FIX"
          fi
          
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT
          echo "Detected prefix: $PREFIX"
      
      - name: Comment with Workflow ID
        uses: actions/github-script@v7
        with:
          script: |
            const workflowId = '${{ steps.generate-id.outputs.workflow_id }}';
            const prefix = '${{ steps.detect-prefix.outputs.prefix }}';
            
            const body = `ðŸ¤– **Workflow ID Generated**
            
            \`${workflowId}\`
            
            **Next steps:**
            1. Add this issue to [Project #9](https://github.com/orgs/BlackRoad-OS/projects/9)
            2. Set the **Workflow ID** field to: \`${workflowId}\`
            3. Fill in other required fields:
               - Intent (why this exists)
               - Scope (blast radius)
               - Risk (uncertainty level)
               - State (Active/Paused/Speculative)
            
            ---
            
            ðŸ’¡ Detected prefix: \`${prefix}\` based on labels
            
            Prefix meanings:
            - \`WF\` = Standard workflow
            - \`SEC\` = Security-related
            - \`INF\` = Infrastructure
            - \`EXP\` = Experimental
            - \`FIX\` = Hotfix/urgent
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
      
      - name: Add to Project (if not already added)
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Note: This requires project permissions
            // May need to be done manually or with a PAT
            console.log('Project auto-add would happen here');
            console.log('Requires: project scope in token');
