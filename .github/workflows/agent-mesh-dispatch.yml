name: "ðŸ¤– Agent Mesh Dispatch"

on:
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent to invoke (e.g., Cecilia, blackroad-analyst)'
        required: true
        default: 'blackroad-analyst'
      prompt:
        description: 'Task/prompt for the agent'
        required: true
      target:
        description: 'Where to run (local/edge/cloudflare/auto)'
        required: false
        default: 'auto'

  repository_dispatch:
    types: [agent-task]

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  OLLAMA_HOST: ${{ secrets.OLLAMA_HOST || 'http://localhost:11434' }}
  CLOUDFLARE_WORKER: https://blackroad-agents.blackroad.workers.dev

jobs:
  dispatch-agent:
    name: Dispatch Agent Task
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup context
        id: context
        run: |
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT

      - name: Determine target
        id: target
        run: |
          TARGET="${{ github.event.inputs.target || 'auto' }}"

          if [ "$TARGET" = "auto" ]; then
            # Try Cloudflare worker first (most reliable in CI)
            TARGET="cloudflare"
          fi

          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "Selected target: $TARGET"

      - name: Call Cloudflare Agent Worker
        if: steps.target.outputs.target == 'cloudflare'
        id: cloudflare
        run: |
          RESPONSE=$(curl -s -X POST "$CLOUDFLARE_WORKER/agent" \
            -H "Content-Type: application/json" \
            -d '{
              "request": "${{ github.event.inputs.prompt }}",
              "agent": "${{ github.event.inputs.agent }}",
              "repo": "${{ github.repository }}",
              "context": {
                "run_id": "${{ github.run_id }}",
                "triggered_by": "${{ github.actor }}",
                "ref": "${{ github.ref }}"
              }
            }')

          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Agent response:"
          echo "$RESPONSE" | jq '.' || echo "$RESPONSE"

      - name: Call Edge Ollama
        if: steps.target.outputs.target == 'edge'
        id: edge
        run: |
          # Try Tailscale edge devices
          for HOST in "100.109.14.17" "100.108.132.8" "100.77.210.18"; do
            RESPONSE=$(curl -s --connect-timeout 5 "http://$HOST:11434/api/generate" \
              -d '{
                "model": "${{ github.event.inputs.agent }}",
                "prompt": "${{ github.event.inputs.prompt }}",
                "stream": false
              }' 2>/dev/null)

            if [ -n "$RESPONSE" ]; then
              echo "response<<EOF" >> $GITHUB_OUTPUT
              echo "$RESPONSE" | jq -r '.response' >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "Got response from $HOST"
              exit 0
            fi
          done

          echo "No edge devices reachable"
          exit 1

      - name: Log to Agent Registry
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.cloudflare.outputs.response || steps.edge.outputs.response || 'No response' }}`;
            const agent = '${{ github.event.inputs.agent }}';
            const prompt = '${{ github.event.inputs.prompt }}';

            // Create a summary
            await core.summary
              .addHeading('ðŸ¤– Agent Mesh Dispatch Results')
              .addTable([
                [{data: 'Agent', header: true}, {data: 'Prompt', header: true}, {data: 'Target', header: true}],
                [agent, prompt.substring(0, 50) + '...', '${{ steps.target.outputs.target }}']
              ])
              .addHeading('Response', 3)
              .addCodeBlock(response.substring(0, 2000), 'json')
              .write();

      - name: Create Issue with Results (optional)
        if: github.event.inputs.create_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.cloudflare.outputs.response || steps.edge.outputs.response }}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ¤– Agent Task: ${{ github.event.inputs.agent }}`,
              body: `## Agent Response\n\n\`\`\`\n${response}\n\`\`\`\n\n---\nTriggered by: @${{ github.actor }}\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });

  sync-to-registry:
    name: Sync Agent Activity
    runs-on: ubuntu-latest
    needs: dispatch-agent
    if: always()

    steps:
      - name: Update Cloudflare KV
        run: |
          curl -s -X POST "$CLOUDFLARE_WORKER/log" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "agent_dispatch",
              "agent": "${{ github.event.inputs.agent }}",
              "repo": "${{ github.repository }}",
              "status": "${{ needs.dispatch-agent.result }}",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }' || true
