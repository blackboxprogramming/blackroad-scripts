name: Traffic Light Conflict Detection

on:
  # Run on schedule (every 15 minutes)
  schedule:
    - cron: '*/15 * * * *'
  
  # Allow manual trigger
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  check-traffic-lights:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Query Project for Red/Yellow Lights
        id: check-conflicts
        uses: actions/github-script@v7
        with:
          script: |
            // Query GitHub Projects API for workflows with Red/Yellow traffic lights
            // Note: This requires GraphQL and project permissions
            
            const query = `
              query($org: String!, $projectNumber: Int!) {
                organization(login: $org) {
                  projectV2(number: $projectNumber) {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            number
                            title
                            url
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2SingleSelectField {
                                  name
                                }
                              }
                            }
                            ... on ProjectV2ItemFieldTextValue {
                              text
                              field {
                                ... on ProjectV2Field {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            try {
              const result = await github.graphql(query, {
                org: 'BlackRoad-OS',
                projectNumber: 9
              });
              
              // Parse items and find conflicts
              const items = result.organization.projectV2.items.nodes;
              const conflicts = [];
              const serviceMap = new Map();
              
              for (const item of items) {
                let trafficLight = null;
                let service = null;
                let state = null;
                let agent = null;
                
                for (const fieldValue of item.fieldValues.nodes) {
                  if (fieldValue.field?.name === 'Traffic Light') {
                    trafficLight = fieldValue.name;
                  } else if (fieldValue.field?.name === 'Service') {
                    service = fieldValue.name;
                  } else if (fieldValue.field?.name === 'State') {
                    state = fieldValue.name;
                  } else if (fieldValue.field?.name === 'Agent') {
                    agent = fieldValue.text;
                  }
                }
                
                // Only check active workflows with Red or Yellow lights
                if (state === 'Active' && (trafficLight === 'ðŸ”´ Red' || trafficLight === 'ðŸŸ¡ Yellow')) {
                  const key = service || 'unknown';
                  if (!serviceMap.has(key)) {
                    serviceMap.set(key, []);
                  }
                  serviceMap.get(key).push({
                    issue: item.content?.number,
                    title: item.content?.title,
                    url: item.content?.url,
                    trafficLight,
                    agent
                  });
                }
              }
              
              // Detect conflicts (multiple workflows on same service)
              for (const [service, workflows] of serviceMap.entries()) {
                if (workflows.length > 1) {
                  const reds = workflows.filter(w => w.trafficLight === 'ðŸ”´ Red');
                  if (reds.length > 0) {
                    conflicts.push({
                      service,
                      workflows,
                      severity: 'HIGH'
                    });
                  } else {
                    conflicts.push({
                      service,
                      workflows,
                      severity: 'MEDIUM'
                    });
                  }
                }
              }
              
              core.setOutput('conflicts', JSON.stringify(conflicts));
              core.setOutput('has_conflicts', conflicts.length > 0);
              
              console.log(`Found ${conflicts.length} potential conflicts`);
              
            } catch (error) {
              console.error('Error querying project:', error);
              core.setOutput('has_conflicts', false);
            }
      
      - name: Create Alert Issue
        if: steps.check-conflicts.outputs.has_conflicts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const conflicts = JSON.parse('${{ steps.check-conflicts.outputs.conflicts }}');
            
            let body = `# ðŸš¨ Traffic Light Conflicts Detected\n\n`;
            body += `**Time**: ${new Date().toISOString()}\n\n`;
            body += `Found ${conflicts.length} potential conflicts in active workflows.\n\n`;
            body += `---\n\n`;
            
            for (const conflict of conflicts) {
              const emoji = conflict.severity === 'HIGH' ? 'ðŸ”´' : 'ðŸŸ¡';
              body += `## ${emoji} ${conflict.service}\n\n`;
              body += `**Severity**: ${conflict.severity}\n\n`;
              body += `**Conflicting workflows**:\n`;
              
              for (const wf of conflict.workflows) {
                body += `- ${wf.trafficLight} [#${wf.issue} ${wf.title}](${wf.url})`;
                if (wf.agent) {
                  body += ` (Agent: ${wf.agent})`;
                }
                body += `\n`;
              }
              
              body += `\n**Action needed**: Coordinate between agents/teams before proceeding.\n\n`;
            }
            
            body += `---\n\n`;
            body += `ðŸ’¡ **Tip**: Check [IDX: Traffic Control](https://github.com/orgs/BlackRoad-OS/projects/9/views/1) view for details.\n`;
            
            // Check if alert issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'traffic-light-alert',
              state: 'open'
            });
            
            if (existingIssues.data.length === 0) {
              // Create new alert issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Traffic Light Conflicts - ${new Date().toISOString().split('T')[0]}`,
                body: body,
                labels: ['traffic-light-alert', 'automation']
              });
            } else {
              // Update existing alert
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: body
              });
              
              // Add comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `ðŸ”„ Updated: ${new Date().toISOString()}`
              });
            }
