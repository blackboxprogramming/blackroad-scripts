#!/bin/bash
# Lucidia v2.0 - Local Multi-Model Coding Assistant
# Now powered by daemon with context awareness

VERSION="2.0.0"
DAEMON_API="http://localhost:11435"
LUCIDIA_DIR="$HOME/.lucidia"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check if daemon is running, start if needed
ensure_daemon() {
  if ! curl -s "$DAEMON_API/health" > /dev/null 2>&1; then
    echo -e "${YELLOW}Starting daemon...${NC}"
    ~/.local/bin/lucidia-daemon start > /dev/null 2>&1
    sleep 2
  fi
}

# Show header
show_header() {
  clear
  cat <<'HEADER'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   ü¶ô Lucidia v2.0 - Multi-Model Coding Assistant      ‚ïë
‚ïë   Index-first ‚Ä¢ Context-aware ‚Ä¢ Local-first          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
HEADER
  echo ""
}

# Get context
get_context() {
  cd "$LUCIDIA_DIR"
  node -e "const C=require('./lib/context'); new C().detect().then(c=>console.log(new C().format(c)))" 2>/dev/null || echo ""
}

# Execute task with single model (STREAMING MODE!)
execute_task() {
  local prompt="$1"
  local model="${2:-code}"
  
  echo -e "${CYAN}‚ö° Streaming with ${model} model...${NC}\n"
  
  # Get model name from config
  local model_name=$(cd "$LUCIDIA_DIR" && node -e "const C=require('./lib/config'); const c=new C(); console.log(c.getModel('$model').name)" 2>/dev/null || echo "qwen2.5:0.5b")
  
  local start_time=$(date +%s.%N)
  
  # Stream the response (typing effect!)
  curl -X POST http://localhost:11434/api/generate \
    -H "Content-Type: application/json" \
    -d "{
      \"model\": \"$model_name\",
      \"prompt\": \"$prompt\",
      \"stream\": true
    }" 2>/dev/null | while IFS= read -r line; do
      echo "$line" | jq -r '.response // empty' | tr -d '\n'
    done
  
  local end_time=$(date +%s.%N)
  local duration=$(echo "$end_time - $start_time" | bc)
  
  echo -e "\n\n${GREEN}Model: $model_name ‚Ä¢ Time: ${duration}s${NC}\n"
}

# Execute with multiple models (collaboration)
execute_collab() {
  local prompt="$1"
  
  echo -e "${CYAN}ü§ù Multi-model collaboration...${NC}\n"
  
  response=$(curl -s -X POST "$DAEMON_API/api/collab" \
    -H "Content-Type: application/json" \
    -d "{\"prompt\":\"$prompt\"}")
  
  # Parse and display side-by-side
  echo "$response" | node -e "
    const data = JSON.parse(require('fs').readFileSync(0, 'utf8'));
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë  üìä Multi-Model Results (' + data.models.length + ' models)                      ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
    
    data.models.forEach((m, i) => {
      console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
      console.log('‚îÇ  Model ' + (i+1) + ': ' + m.model.padEnd(44) + '‚îÇ');
      console.log('‚îÇ  Role: ' + m.role.padEnd(47) + '‚îÇ');
      console.log('‚îÇ  Time: ' + m.time.toFixed(2) + 's'.padEnd(47) + '‚îÇ');
      console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n');
      console.log(m.error || m.response);
      console.log('\n');
    });
  "
}

# Chat mode
chat_mode() {
  show_header
  echo -e "${GREEN}üí¨ Chat Mode${NC}"
  echo "Type your question. Type 'exit' to quit."
  echo ""
  
  while true; do
    echo -n -e "${BLUE}You:${NC} "
    read -r prompt
    
    [[ "$prompt" == "exit" ]] && break
    [[ -z "$prompt" ]] && continue
    
    echo ""
    execute_task "$prompt" "code"
    echo ""
  done
}

# Task mode
task_mode() {
  local task="$1"
  show_header
  execute_collab "$task"
}

# Analyze mode
analyze_mode() {
  local path="$1"
  show_header
  echo -e "${CYAN}Analyzing: $path${NC}\n"
  
  if [ -f "$path" ]; then
    content=$(cat "$path")
    prompt="Analyze this code and suggest improvements:\n\n$content"
  else
    prompt="Analyze the architecture of the $path directory and suggest improvements"
  fi
  
  execute_task "$prompt" "smart"
}

# Review mode
review_mode() {
  local file="$1"
  show_header
  echo -e "${CYAN}Reviewing: $file${NC}\n"
  
  content=$(cat "$file" 2>/dev/null || echo "File not found")
  prompt="Review this code for quality, security, and best practices:\n\n$content"
  
  execute_collab "$prompt"
}

# Context mode
context_mode() {
  show_header
  get_context
}

# Main menu
show_menu() {
  show_header
  
  # Show context
  get_context
  
  echo -e "${BLUE}Commands:${NC}"
  echo "  1. üí¨ chat       Interactive chat"
  echo "  2. üîß task       Execute task (multi-model)"
  echo "  3. üîç analyze    Analyze code/architecture"
  echo "  4. üß™ review     Code review"
  echo "  5. üìã context    Show context"
  echo "  6. üìä status     Daemon status"
  echo "  0. ‚Üê exit"
  echo ""
  echo -n "Choose: "
  
  read -r choice
  
  case "$choice" in
    1) chat_mode ;;
    2) 
      echo -n "Task: "
      read -r task
      task_mode "$task"
      ;;
    3)
      echo -n "Path: "
      read -r path
      analyze_mode "$path"
      ;;
    4)
      echo -n "File: "
      read -r file
      review_mode "$file"
      ;;
    5) context_mode ;;
    6) ~/.local/bin/lucidia-daemon status ;;
    0) exit 0 ;;
    *) echo "Invalid choice" ;;
  esac
  
  echo ""
  read -p "Press Enter to continue..."
  show_menu
}

# Command-line interface
case "$1" in
  chat)
    ensure_daemon
    chat_mode
    ;;
  task)
    ensure_daemon
    task_mode "$2"
    ;;
  analyze)
    ensure_daemon
    analyze_mode "$2"
    ;;
  review)
    ensure_daemon
    review_mode "$2"
    ;;
  context)
    ensure_daemon
    context_mode
    ;;
  collab)
    ensure_daemon
    execute_collab "$2"
    ;;
  --help|-h)
    echo "Lucidia v2.0 - Multi-Model Coding Assistant"
    echo ""
    echo "Usage:"
    echo "  lucidia              Interactive menu"
    echo "  lucidia chat         Start chat mode"
    echo "  lucidia task <desc>  Execute task (multi-model)"
    echo "  lucidia collab <desc> Collaborate (multi-model)"
    echo "  lucidia analyze <path> Analyze code"
    echo "  lucidia review <file>  Review code"
    echo "  lucidia context      Show context"
    ;;
  *)
    ensure_daemon
    show_menu
    ;;
esac
