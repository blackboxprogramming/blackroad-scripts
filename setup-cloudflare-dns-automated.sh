#!/bin/bash

# Automated Cloudflare DNS Setup for blackroad.io â†’ Railway
# This script creates/updates DNS records for br-apps services

set -e

CF_TOKEN='yP5h0HvsXX0BpHLs01tLmgtTbQurIKPL4YnQfIwy'
CF_ZONE='848cf0b18d51e0170e0d1537aec3505a'

echo "â˜ï¸  Cloudflare DNS Automation for blackroad.io"
echo "================================================"
echo ""

# Function to create or update DNS record
upsert_dns_record() {
  local name="$1"
  local target="$2"
  local proxy="${3:-true}"
  local record_type="CNAME"

  echo "ğŸ“ Processing: ${name}.blackroad.io â†’ $target"

  # Handle root domain (@)
  local lookup_name="${name}.blackroad.io"
  if [ "$name" = "@" ]; then
    lookup_name="blackroad.io"
  fi

  # Check if record exists
  EXISTING=$(curl -s -X GET \
    "https://api.cloudflare.com/client/v4/zones/${CF_ZONE}/dns_records?name=${lookup_name}&type=${record_type}" \
    -H "Authorization: Bearer ${CF_TOKEN}" \
    -H "Content-Type: application/json")

  RECORD_ID=$(echo "$EXISTING" | jq -r '.result[0].id // empty')
  SUCCESS=$(echo "$EXISTING" | jq -r '.success')

  if [ "$SUCCESS" != "true" ]; then
    echo "   âŒ Error fetching existing record"
    echo "$EXISTING" | jq '.errors'
    return 1
  fi

  if [ -n "$RECORD_ID" ] && [ "$RECORD_ID" != "null" ]; then
    # Update existing record
    echo "   ğŸ”„ Updating existing record (ID: ${RECORD_ID})"
    RESPONSE=$(curl -s -X PATCH \
      "https://api.cloudflare.com/client/v4/zones/${CF_ZONE}/dns_records/${RECORD_ID}" \
      -H "Authorization: Bearer ${CF_TOKEN}" \
      -H "Content-Type: application/json" \
      -d "{
        \"type\": \"${record_type}\",
        \"name\": \"${name}\",
        \"content\": \"${target}\",
        \"proxied\": ${proxy},
        \"ttl\": 1
      }")
  else
    # Create new record
    echo "   â• Creating new record"
    RESPONSE=$(curl -s -X POST \
      "https://api.cloudflare.com/client/v4/zones/${CF_ZONE}/dns_records" \
      -H "Authorization: Bearer ${CF_TOKEN}" \
      -H "Content-Type: application/json" \
      -d "{
        \"type\": \"${record_type}\",
        \"name\": \"${name}\",
        \"content\": \"${target}\",
        \"proxied\": ${proxy},
        \"ttl\": 1
      }")
  fi

  RESPONSE_SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
  if [ "$RESPONSE_SUCCESS" = "true" ]; then
    echo "   âœ… Success!"
  else
    echo "   âŒ Failed!"
    echo "$RESPONSE" | jq '.errors'
  fi
  echo ""
}

# Get Railway domains from user
echo "âš ï¸  You need the Railway domains from your deployed services"
echo ""
echo "To find them:"
echo "  1. Go to https://railway.app/dashboard"
echo "  2. Open the br-apps project"
echo "  3. Click each service â†’ Settings â†’ Networking"
echo "  4. Copy the 'Public Domain' (e.g., web-production.up.railway.app)"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

read -p "Enter Railway domain for WEB service (e.g., web-production.up.railway.app): " WEB_DOMAIN
read -p "Enter Railway domain for API service (e.g., api-production.up.railway.app): " API_DOMAIN

# Validate inputs
if [ -z "$WEB_DOMAIN" ] || [ -z "$API_DOMAIN" ]; then
  echo ""
  echo "âŒ Error: Both domains are required!"
  exit 1
fi

# Confirm before proceeding
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Ready to create these DNS records:"
echo ""
echo "  www.blackroad.io  â†’ $WEB_DOMAIN"
echo "  blackroad.io (@)  â†’ $WEB_DOMAIN"
echo "  api.blackroad.io  â†’ $API_DOMAIN"
echo ""
read -p "Continue? (y/n): " CONFIRM

if [ "$CONFIRM" != "y" ] && [ "$CONFIRM" != "Y" ]; then
  echo "Aborted."
  exit 0
fi

echo ""
echo "ğŸš€ Creating/updating DNS records..."
echo ""

# Create records
upsert_dns_record "www" "$WEB_DOMAIN" "true"
upsert_dns_record "@" "$WEB_DOMAIN" "true"
upsert_dns_record "api" "$API_DOMAIN" "true"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âœ… DNS setup complete!"
echo ""
echo "ğŸ”— Your domains:"
echo "   https://www.blackroad.io"
echo "   https://blackroad.io"
echo "   https://api.blackroad.io"
echo ""
echo "â±  DNS propagation: ~5-10 minutes"
echo "ğŸ”’ SSL certificates: Auto-generated by Railway"
echo ""
echo "ğŸ§ª Test with:"
echo "   curl -I https://www.blackroad.io"
echo "   curl -I https://api.blackroad.io"
echo ""
echo "ğŸ“Š View records: https://dash.cloudflare.com/${CF_ZONE}/dns"
echo ""
